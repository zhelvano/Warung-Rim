<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="utf-8">
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WarungRIM | Top Up E-wallet & Jasa Digital</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css">
    
    <style>
        /* Semua kode CSS sebelumnya tetap dipertahankan */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: #f8f9fa;
            color: #333;
            line-height: 1.6;
        }
        
        /* ... Kode CSS sebelumnya tetap sama ... */
        
        /* Payment Status Styles */
        .payment-status-container {
            text-align: center;
            padding: 20px;
            margin: 20px 0;
            border-radius: 10px;
            background: #f8f9fa;
        }
        
        .payment-success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        
        .payment-pending {
            background: #fff3cd;
            color: #856404;
            border: 1px solid #ffeaa7;
        }
        
        .payment-failed {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        
        .va-number-display {
            font-size: 22px;
            font-weight: bold;
            letter-spacing: 2px;
            background: white;
            padding: 15px;
            border-radius: 8px;
            margin: 15px 0;
            border: 2px dashed #DA6B0E;
            color: #DA6B0E;
        }
        
        .timer-display {
            font-size: 18px;
            font-weight: bold;
            color: #dc3545;
            margin: 10px 0;
        }
        
        .copy-btn {
            background: #DA6B0E;
            color: white;
            border: none;
            padding: 8px 15px;
            border-radius: 5px;
            cursor: pointer;
            margin-left: 10px;
            font-size: 14px;
        }
        
        .copy-btn:hover {
            background: #c45c0d;
        }
        
        .payment-method-display {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            margin: 15px 0;
            padding: 10px;
            background: white;
            border-radius: 8px;
            border: 1px solid #eee;
        }
        
        .method-logo {
            width: 40px;
            height: 40px;
            object-fit: contain;
        }
        
        /* Test Mode Badge */
        .test-mode-badge {
            position: fixed;
            top: 70px;
            right: 20px;
            background: #ffc107;
            color: #856404;
            padding: 5px 10px;
            border-radius: 4px;
            font-size: 12px;
            font-weight: bold;
            z-index: 999;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }
    </style>
</head>
<body>
    <!-- Test Mode Badge -->
    <div class="test-mode-badge" id="testModeBadge">
        <i class="fas fa-flask"></i> MODE SIMULASI
    </div>

    <!-- WhatsApp Button -->
    <a href="https://wa.me/6285923331022" class="whatsapp-btn" target="_blank">
        <i class="fab fa-whatsapp"></i>
    </a>

    <!-- Header -->
    <header class="header">
        <div class="header-container">
            <a href="#" class="logo">
                <i class="fas fa-store"></i> WarungRIM
            </a>
            <nav class="nav">
                <a href="#" onclick="showAdminPanel()">
                    <i class="fas fa-user-shield"></i> Admin
                </a>
                <a href="#contact">
                    <i class="fas fa-phone"></i> Kontak
                </a>
                <a href="#faq">
                    <i class="fas fa-question-circle"></i> FAQ
                </a>
            </nav>
        </div>
    </header>

    <!-- Banner -->
    <div class="banner">
        <img src="https://images.unsplash.com/photo-1551288049-bebda4e38f71?ixlib=rb-4.0.3&auto=format&fit=crop&w=1200&q=80" alt="WarungRIM">
    </div>

    <!-- Top Products -->
    <h2 class="section-title">PRODUK UNGGULAN</h2>
    <div class="products-grid" id="topProducts">
        <!-- Top products akan diisi oleh JavaScript -->
    </div>

    <!-- Category Tabs -->
    <div class="tabs">
        <button class="tab-btn active" onclick="switchCategory('jasa')">
            <i class="fas fa-code"></i> Jasa Digital
        </button>
        <button class="tab-btn" onclick="switchCategory('ewallet')">
            <i class="fas fa-wallet"></i> Top Up E-wallet
        </button>
    </div>

    <!-- Products Grid -->
    <h2 class="section-title" id="categoryTitle">JASA DIGITAL</h2>
    <div class="products-grid" id="productsGrid">
        <!-- Products akan diisi oleh JavaScript -->
    </div>

    <!-- Payment Methods -->
    <div class="payment-section">
        <h3 style="margin-bottom: 20px;">
            <i class="fas fa-credit-card"></i> Metode Pembayaran
        </h3>
        <div class="payment-icons">
            <img src="https://upload.wikimedia.org/wikipedia/commons/thumb/5/5c/Bank_Central_Asia.svg/512px-Bank_Central_Asia.svg.png" alt="BCA">
            <img src="https://upload.wikimedia.org/wikipedia/commons/thumb/a/a0/Bank_Mandiri_logo.svg/512px-Bank_Mandiri_logo.svg.png" alt="Mandiri">
            <img src="https://upload.wikimedia.org/wikipedia/commons/thumb/6/6e/BRI_logo.svg/512px-BRI_logo.svg.png" alt="BRI">
            <img src="https://upload.wikimedia.org/wikipedia/commons/thumb/4/41/BNI_logo.svg/512px-BNI_logo.svg.png" alt="BNI">
            <img src="https://upload.wikimedia.org/wikipedia/commons/thumb/d/d0/QR_code_for_mobile_English_Wikipedia.svg/512px-QR_code_for_mobile_English_Wikipedia.svg.png" alt="QRIS">
            <img src="https://upload.wikimedia.org/wikipedia/commons/thumb/8/8c/GoPay_logo.svg/512px-GoPay_logo.svg.png" alt="GoPay">
            <img src="https://upload.wikimedia.org/wikipedia/commons/thumb/e/eb/Logo_ovo_purple.svg/512px-Logo_ovo_purple.svg.png" alt="OVO">
            <img src="https://upload.wikimedia.org/wikipedia/commons/thumb/7/72/Logo_dana_blue.svg/512px-Logo_dana_blue.svg.png" alt="DANA">
        </div>
        <p style="color: #666; margin-top: 15px;">
            <i class="fas fa-info-circle"></i> 
            Semua biaya admin sudah termasuk dalam harga
        </p>
        <p style="color: #ffc107; font-size: 14px; margin-top: 10px;">
            <i class="fas fa-flask"></i> Saat ini menggunakan mode simulasi. Untuk pembayaran real, hubungi admin.
        </p>
    </div>

    <!-- Checkout Modal -->
    <div class="modal-overlay" id="checkoutModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Checkout Produk</h3>
                <button class="close-modal" onclick="closeCheckoutModal()">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="modal-body">
                <!-- Step 1: Product Details -->
                <div id="step1">
                    <div id="productDetails"></div>
                    <div id="stockStatus" class="alert" style="display: none;"></div>
                    
                    <div id="ewalletNominals" style="display: none;"></div>
                    
                    <div class="price-summary">
                        <div class="price-row">
                            <span>Harga Produk:</span>
                            <span id="priceBase">-</span>
                        </div>
                        <div class="price-row">
                            <span>Biaya Layanan:</span>
                            <span id="priceFee">-</span>
                        </div>
                        <div class="price-row">
                            <span>Biaya Admin (2.5%):</span>
                            <span id="priceAdmin">-</span>
                        </div>
                        <div class="price-row total">
                            <span>TOTAL BAYAR:</span>
                            <span id="priceTotal">-</span>
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label for="customerName">
                            <i class="fas fa-user"></i> Nama Lengkap *
                        </label>
                        <input type="text" id="customerName" class="form-control" required>
                    </div>
                    
                    <div class="form-group">
                        <label for="customerEmail">
                            <i class="fas fa-envelope"></i> Email *
                        </label>
                        <input type="email" id="customerEmail" class="form-control" required>
                    </div>
                    
                    <div class="form-group">
                        <label for="customerPhone">
                            <i class="fas fa-phone"></i> Nomor WhatsApp *
                        </label>
                        <input type="tel" id="customerPhone" class="form-control" required>
                    </div>
                    
                    <button class="btn-pay" onclick="proceedToPayment()" id="btnProceedPayment">
                        <i class="fas fa-credit-card"></i> Lanjutkan ke Pembayaran
                    </button>
                </div>
                
                <!-- Step 2: Payment Method Selection -->
                <div id="step2" style="display: none;">
                    <h4 style="text-align: center; margin-bottom: 20px;">
                        <i class="fas fa-credit-card"></i> Pilih Metode Pembayaran
                    </h4>
                    
                    <div class="alert alert-warning" style="margin-bottom: 20px;">
                        <i class="fas fa-flask"></i> <strong>Mode Simulasi Aktif</strong><br>
                        Untuk pembayaran real dengan Violet Media Pay, hubungi admin untuk setup API credentials.
                    </div>
                    
                    <div class="payment-methods-container">
                        <div class="payment-tabs">
                            <button class="payment-tab active" onclick="switchPaymentTab('qris')">
                                QRIS
                            </button>
                            <button class="payment-tab" onclick="switchPaymentTab('va')">
                                Virtual Account
                            </button>
                            <button class="payment-tab" onclick="switchPaymentTab('ewallet')">
                                E-Wallet
                            </button>
                            <button class="payment-tab" onclick="switchPaymentTab('manual')">
                                <i class="fas fa-hand-holding-usd"></i> Manual
                            </button>
                        </div>
                        
                        <!-- QRIS Tab -->
                        <div id="paymentTabQris" class="payment-tab-content">
                            <div class="vmpay-container">
                                <p>Scan QRIS untuk pembayaran instan</p>
                                <div class="qris-code" id="qrisDisplay">
                                    <!-- QR Code akan ditampilkan di sini -->
                                </div>
                            </div>
                        </div>
                        
                        <!-- Virtual Account Tab -->
                        <div id="paymentTabVa" class="payment-tab-content" style="display: none;">
                            <p>Pilih bank untuk Virtual Account:</p>
                            <div class="virtual-account-banks" id="vaBanks">
                                <!-- Bank options will be loaded here -->
                            </div>
                            <div id="vaDetails" style="display: none; margin-top: 20px;">
                                <div class="va-number-display" id="vaNumberDisplay">
                                    <!-- VA Number akan ditampilkan di sini -->
                                </div>
                                <div class="timer-display" id="vaTimer">
                                    Batas waktu: <span id="countdown">23:59:59</span>
                                </div>
                                <button onclick="copyToClipboard('vaNumber')" class="copy-btn">
                                    <i class="fas fa-copy"></i> Salin Nomor VA
                                </button>
                            </div>
                        </div>
                        
                        <!-- E-Wallet Tab -->
                        <div id="paymentTabEwallet" class="payment-tab-content" style="display: none;">
                            <p>Pilih e-wallet:</p>
                            <div id="ewalletOptions">
                                <!-- E-wallet options will be loaded here -->
                            </div>
                            <div id="ewalletDetails" style="display: none; margin-top: 20px;">
                                <div class="payment-method-display">
                                    <img id="ewalletLogo" src="" alt="E-Wallet" class="method-logo">
                                    <div>
                                        <h5 id="ewalletName">E-Wallet</h5>
                                        <p id="ewalletInstructionText">Instruksi pembayaran</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Manual Payment Tab -->
                        <div id="paymentTabManual" class="payment-tab-content" style="display: none;">
                            <div class="payment-status-container payment-pending">
                                <h4><i class="fas fa-hand-holding-usd"></i> Pembayaran Manual</h4>
                                <p>Untuk pembayaran manual, silakan transfer ke:</p>
                                
                                <div style="text-align: left; background: white; padding: 15px; border-radius: 8px; margin: 15px 0;">
                                    <p><strong>Bank BCA</strong></p>
                                    <p>No. Rekening: <strong>1234567890</strong></p>
                                    <p>Atas Nama: <strong>WARUNGRIM STORE</strong></p>
                                    <p>Jumlah: <strong id="manualAmount"></strong></p>
                                    <p>Order ID: <strong id="manualOrderId"></strong></p>
                                </div>
                                
                                <p>Setelah transfer, klik tombol di bawah untuk konfirmasi via WhatsApp:</p>
                                <button onclick="confirmManualPayment()" class="btn-pay">
                                    <i class="fab fa-whatsapp"></i> Konfirmasi Pembayaran Manual
                                </button>
                            </div>
                        </div>
                    </div>
                    
                    <div id="paymentInstruction" class="payment-instruction" style="display: none;">
                        <p><strong>Instruksi Pembayaran:</strong></p>
                        <div id="instructionContent"></div>
                    </div>
                    
                    <div id="paymentStatus" class="status-message" style="display: none;"></div>
                    
                    <div style="text-align: center; margin-top: 20px;">
                        <button onclick="checkPaymentStatus()" class="btn-pay" id="checkStatusBtn" style="margin: 5px;">
                            <i class="fas fa-sync-alt"></i> Cek Status Pembayaran
                        </button>
                        <button onclick="simulatePayment()" class="btn-pay" id="simulateBtn" style="background: #28a745; margin: 5px;">
                            <i class="fas fa-flask"></i> Simulasikan Pembayaran Berhasil
                        </button>
                        <button onclick="backToStep1()" style="background: none; border: 1px solid #ddd; color: #666; padding: 10px 20px; border-radius: 8px; margin-top: 10px; cursor: pointer;">
                            <i class="fas fa-arrow-left"></i> Kembali ke Detail Pesanan
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Admin Panel -->
    <div class="modal-overlay" id="adminModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Panel Admin WarungRIM</h3>
                <button class="close-modal" onclick="closeAdminModal()">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="modal-body">
                <div id="adminLogin" style="display: block;">
                    <h4 style="text-align: center; margin-bottom: 20px;">Login Admin</h4>
                    <div class="form-group">
                        <label>Username</label>
                        <input type="text" id="adminUsername" class="form-control" value="admin">
                    </div>
                    <div class="form-group">
                        <label>Password</label>
                        <input type="password" id="adminPassword" class="form-control" value="warungrim2025">
                    </div>
                    <button class="btn-pay" onclick="loginAdmin()">
                        <i class="fas fa-sign-in-alt"></i> Login
                    </button>
                    
                    <div style="margin-top: 20px; padding: 15px; background: #f8f9fa; border-radius: 8px;">
                        <h5><i class="fas fa-cog"></i> Konfigurasi Violet Media Pay</h5>
                        <div class="form-group">
                            <label>API Key</label>
                            <input type="text" id="vmpayApiKey" class="form-control" placeholder="Masukkan API Key">
                        </div>
                        <div class="form-group">
                            <label>Secret Key</label>
                            <input type="password" id="vmpaySecretKey" class="form-control" placeholder="Masukkan Secret Key">
                        </div>
                        <button onclick="saveVMPayConfig()" class="btn-pay" style="background: #6f42c1;">
                            <i class="fas fa-save"></i> Simpan Konfigurasi
                        </button>
                    </div>
                </div>
                
                <div id="adminDashboard" style="display: none;">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                        <h4>Dashboard Admin</h4>
                        <button onclick="logoutAdmin()" style="background: #dc3545; color: white; border: none; padding: 8px 15px; border-radius: 5px; cursor: pointer;">
                            <i class="fas fa-sign-out-alt"></i> Logout
                        </button>
                    </div>
                    
                    <!-- Tabs untuk Admin -->
                    <div class="tabs" style="margin: 0 0 20px 0;">
                        <button class="tab-btn active" onclick="showAdminTab('products')">
                            <i class="fas fa-box"></i> Kelola Produk
                        </button>
                        <button class="tab-btn" onclick="showAdminTab('transactions')">
                            <i class="fas fa-receipt"></i> Transaksi
                        </button>
                        <button class="tab-btn" onclick="showAdminTab('stock')">
                            <i class="fas fa-cubes"></i> Kelola Stock
                        </button>
                        <button class="tab-btn" onclick="showAdminTab('settings')">
                            <i class="fas fa-cog"></i> Settings
                        </button>
                    </div>
                    
                    <!-- Tab Kelola Produk -->
                    <div id="adminProductsTab" class="admin-tab">
                        <h5>Daftar Produk</h5>
                        <div id="adminProductsList" style="max-height: 400px; overflow-y: auto; margin-top: 15px;">
                            <!-- Produk akan ditampilkan di sini -->
                        </div>
                        <button onclick="addNewProduct()" style="background: #28a745; color: white; border: none; padding: 10px 15px; border-radius: 5px; margin-top: 15px; cursor: pointer;">
                            <i class="fas fa-plus"></i> Tambah Produk Baru
                        </button>
                    </div>
                    
                    <!-- Tab Transaksi -->
                    <div id="adminTransactionsTab" class="admin-tab" style="display: none;">
                        <div id="adminStats" style="background: #f9f9fa; padding: 15px; border-radius: 10px; margin-bottom: 20px;">
                            <h5>Statistik</h5>
                            <p>Total Transaksi: <span id="totalTransactions">0</span></p>
                            <p>Total Pendapatan: <span id="totalIncome">Rp 0</span></p>
                            <p>Transaksi Hari Ini: <span id="todayTransactions">0</span></p>
                            <p>Mode Pembayaran: <span id="paymentModeStatus">Simulasi</span></p>
                        </div>
                        
                        <h5>Transaksi Terbaru</h5>
                        <div id="transactionsList" style="max-height: 400px; overflow-y: auto;">
                            <!-- Transaksi akan ditampilkan di sini -->
                        </div>
                    </div>
                    
                    <!-- Tab Kelola Stock -->
                    <div id="adminStockTab" class="admin-tab" style="display: none;">
                        <h5>Kelola Stock Produk</h5>
                        <div id="stockManagement" style="margin-top: 15px;">
                            <!-- Form stock akan ditampilkan di sini -->
                        </div>
                    </div>
                    
                    <!-- Tab Settings -->
                    <div id="adminSettingsTab" class="admin-tab" style="display: none;">
                        <h5>Pengaturan Sistem</h5>
                        <div style="background: #f9f9fa; padding: 15px; border-radius: 8px; margin-bottom: 15px;">
                            <h6><i class="fas fa-credit-card"></i> Konfigurasi Payment Gateway</h6>
                            <div class="form-group">
                                <label>Violet Media Pay API Key</label>
                                <input type="text" id="configApiKey" class="form-control" placeholder="API Key">
                            </div>
                            <div class="form-group">
                                <label>Violet Media Pay Secret Key</label>
                                <input type="password" id="configSecretKey" class="form-control" placeholder="Secret Key">
                            </div>
                            <div class="form-group">
                                <label>Mode</label>
                                <select id="paymentMode" class="form-control">
                                    <option value="simulation">Simulasi</option>
                                    <option value="production">Production</option>
                                </select>
                            </div>
                            <button onclick="updatePaymentConfig()" class="btn-pay" style="background: #6f42c1;">
                                <i class="fas fa-save"></i> Update Konfigurasi
                            </button>
                        </div>
                        
                        <div style="background: #f9f9fa; padding: 15px; border-radius: 8px;">
                            <h6><i class="fas fa-whatsapp"></i> Kontak Admin</h6>
                            <div class="form-group">
                                <label>Nomor WhatsApp Admin</label>
                                <input type="text" id="adminWhatsapp" class="form-control" value="6285923331022">
                            </div>
                            <button onclick="updateAdminContact()" class="btn-pay" style="background: #25D366;">
                                <i class="fab fa-whatsapp"></i> Update WhatsApp
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Footer -->
    <footer class="footer" id="contact">
        <div class="footer-container">
            <div class="footer-logo">WarungRIM</div>
            <p>Top Up E-wallet & Jasa Digital Premium</p>
            <p style="margin: 20px 0;">
                <i class="fas fa-phone"></i> 0859-2333-1022<br>
                <i class="fas fa-envelope"></i> support@warungrim.com
            </p>
            <p style="color: #aaa; font-size: 14px;">
                Setelah pembayaran berhasil, Anda akan diarahkan ke WhatsApp untuk konfirmasi.<br>
                File/jasa akan dikirim setelah admin memverifikasi pembayaran.
            </p>
            <p style="margin-top: 20px; color: #aaa;">
                Â© 2025 WarungRIM. All rights reserved.
            </p>
        </div>
    </footer>

    <script>
        // ================= CONFIGURATION =================
        const CONFIG = {
            WHATSAPP_ADMIN: '6285923331022',
            TELEGRAM_ADMIN: 'https://t.me/rimzohun',
            FEE_PERCENTAGE: 2.5,
            ADMIN_USERNAME: 'admin',
            ADMIN_PASSWORD: 'warungrim2025',
            // Payment Configuration
            PAYMENT_MODE: 'simulation', // 'simulation' or 'production'
            VMPAY_API_KEY: '',
            VMPAY_SECRET_KEY: '',
            VMPAY_BASE_URL: 'https://api.violetmediapay.com/v1',
            VMPAY_SANDBOX_URL: 'https://sandbox.violetmediapay.com/v1',
            MANUAL_BANK_ACCOUNT: '1234567890',
            MANUAL_BANK_NAME: 'BCA',
            MANUAL_ACCOUNT_NAME: 'WARUNGRIM STORE'
        };

        // ================= PRODUCTS DATA =================
        let products = {
            jasa: [
                {
                    id: 1,
                    name: "Repository Userbot VVIP Telegram",
                    basePrice: 300000,
                    image: "fas fa-robot",
                    color: "#DA6B0E",
                    description: "Userbot Telegram premium dengan 100+ fitur",
                    stock: 10,
                    type: "jasa",
                    isActive: true
                },
                {
                    id: 2,
                    name: "Repository Bot Musik Telegram",
                    basePrice: 200000,
                    image: "fas fa-music",
                    color: "#3498db",
                    description: "Bot musik kualitas tinggi",
                    stock: 15,
                    type: "jasa",
                    isActive: true
                },
                {
                    id: 3,
                    name: "SC Zhforce",
                    basePrice: 30000,
                    image: "fas fa-code",
                    color: "#2ecc71",
                    description: "Source code original",
                    stock: 20,
                    type: "jasa",
                    isActive: true
                }
            ],
            ewallet: [
                {
                    id: 101,
                    name: "DANA",
                    image: "fas fa-wallet",
                    color: "#118eea",
                    description: "Top Up Saldo DANA",
                    stock: 999,
                    type: "ewallet",
                    isActive: true
                },
                {
                    id: 102,
                    name: "OVO",
                    image: "fas fa-wallet",
                    color: "#4f2b8c",
                    description: "Top Up Saldo OVO",
                    stock: 999,
                    type: "ewallet",
                    isActive: true
                },
                {
                    id: 103,
                    name: "GoPay",
                    image: "fas fa-wallet",
                    color: "#00a64f",
                    description: "Top Up Saldo GoPay",
                    stock: 999,
                    type: "ewallet",
                    isActive: true
                },
                {
                    id: 104,
                    name: "ShopeePay",
                    image: "fas fa-wallet",
                    color: "#ff531b",
                    description: "Top Up Saldo ShopeePay",
                    stock: 999,
                    type: "ewallet",
                    isActive: true
                }
            ]
        };

        // E-wallet fee structure
        const EWALLET_FEES = [
            { min: 10000, max: 30000, fee: 1000 },
            { min: 31000, max: 50000, fee: 2000 },
            { min: 51000, max: 100000, fee: 3000 },
            { min: 101000, max: 150000, fee: 5000 },
            { min: 151000, max: 200000, fee: 7000 },
            { min: 201000, max: 250000, fee: 9000 },
            { min: 251000, max: 300000, fee: 10000 },
            { min: 301000, max: 500000, fee: 15000 },
            { min: 501000, max: 750000, fee: 20000 },
            { min: 751000, max: 1000000, fee: 25000 }
        ];

        const EWALLET_NOMINALS = [10000, 20000, 25000, 30000, 35000, 40000, 45000, 50000, 
                                  60000, 70000, 75000, 80000, 90000, 100000, 150000, 200000, 
                                  250000, 300000, 500000, 750000, 1000000];

        // Bank list for Virtual Account
        const BANK_LIST = [
            { code: 'bca', name: 'BCA', logo: 'https://upload.wikimedia.org/wikipedia/commons/thumb/5/5c/Bank_Central_Asia.svg/512px-Bank_Central_Asia.svg.png' },
            { code: 'mandiri', name: 'Mandiri', logo: 'https://upload.wikimedia.org/wikipedia/commons/thumb/a/a0/Bank_Mandiri_logo.svg/512px-Bank_Mandiri_logo.svg.png' },
            { code: 'bri', name: 'BRI', logo: 'https://upload.wikimedia.org/wikipedia/commons/thumb/6/6e/BRI_logo.svg/512px-BRI_logo.svg.png' },
            { code: 'bni', name: 'BNI', logo: 'https://upload.wikimedia.org/wikipedia/commons/thumb/4/41/BNI_logo.svg/512px-BNI_logo.svg.png' }
        ];

        // E-wallet list
        const EWALLET_LIST = [
            { code: 'gopay', name: 'GoPay', logo: 'https://upload.wikimedia.org/wikipedia/commons/thumb/8/8c/GoPay_logo.svg/512px-GoPay_logo.svg.png' },
            { code: 'ovo', name: 'OVO', logo: 'https://upload.wikimedia.org/wikipedia/commons/thumb/e/eb/Logo_ovo_purple.svg/512px-Logo_ovo_purple.svg.png' },
            { code: 'dana', name: 'DANA', logo: 'https://upload.wikimedia.org/wikipedia/commons/thumb/7/72/Logo_dana_blue.svg/512px-Logo_dana_blue.svg.png' },
            { code: 'shopeepay', name: 'ShopeePay', logo: 'https://upload.wikimedia.org/wikipedia/commons/thumb/b/b5/ShopeePay_Logo.svg/512px-ShopeePay_Logo.svg.png' }
        ];

        // ================= GLOBAL VARIABLES =================
        let currentCategory = 'jasa';
        let currentProduct = null;
        let selectedNominal = null;
        let currentOrder = null;
        let paymentInterval = null;
        let adminTab = 'products';
        let selectedPaymentMethod = null;
        let selectedBank = null;
        let selectedEwallet = null;
        let paymentTransaction = null;
        let countdownTimer = null;
        let countdownEndTime = null;

        // ================= HELPER FUNCTIONS =================
        function formatCurrency(amount) {
            return 'Rp ' + amount.toLocaleString('id-ID');
        }

        function calculateEwalletFee(nominal) {
            for (const fee of EWALLET_FEES) {
                if (nominal >= fee.min && nominal <= fee.max) {
                    return fee.fee;
                }
            }
            return 0;
        }

        function copyToClipboard(elementId) {
            const element = document.getElementById(elementId);
            const text = element.textContent;
            
            navigator.clipboard.writeText(text).then(() => {
                alert('Nomor VA berhasil disalin!');
            }).catch(err => {
                console.error('Gagal menyalin: ', err);
            });
        }

        // ================= SIMULATION MODE FUNCTIONS =================
        function generateSimulationQRCode() {
            const qrisDisplay = document.getElementById('qrisDisplay');
            
            // Generate random QR code image
            const randomId = Math.random().toString(36).substring(7);
            const qrUrl = `https://api.qrserver.com/v1/create-qr-code/?size=200x200&data=${encodeURIComponent(`WarungRIM Order: ${currentOrder.id} Amount: ${currentOrder.prices.total} Date: ${new Date().toISOString()}`)}`;
            
            qrisDisplay.innerHTML = `
                <img src="${qrUrl}" alt="QR Code" style="width: 100%; height: 100%; object-fit: contain;">
                <p><strong>Scan QR Code di atas</strong></p>
                <p style="font-size: 12px; color: #666;">Order ID: ${currentOrder.id}</p>
                <p style="font-size: 12px; color: #666;">${formatCurrency(currentOrder.prices.total)}</p>
            `;
            
            // Show instruction
            showQRISInstruction();
        }

        function generateSimulationVA(bankCode) {
            const bank = BANK_LIST.find(b => b.code === bankCode);
            if (!bank) return;
            
            // Generate random VA number
            const vaNumber = '8888' + Date.now().toString().slice(-8);
            
            document.getElementById('vaNumberDisplay').innerHTML = `
                <div style="text-align: center;">
                    <p style="margin: 0 0 10px 0;">${bank.name}</p>
                    <div style="font-size: 24px; font-weight: bold;">${vaNumber}</div>
                    <p style="margin: 10px 0 0 0;">${formatCurrency(currentOrder.prices.total)}</p>
                </div>
            `;
            
            // Start countdown timer
            startCountdownTimer();
            
            // Show instruction
            showVAInstruction(bank, vaNumber);
            
            // Store VA number for copying
            document.getElementById('vaNumberDisplay').setAttribute('data-va-number', vaNumber);
        }

        function generateSimulationEwallet(ewalletCode) {
            const ewallet = EWALLET_LIST.find(e => e.code === ewalletCode);
            if (!ewallet) return;
            
            document.getElementById('ewalletLogo').src = ewallet.logo;
            document.getElementById('ewalletName').textContent = ewallet.name;
            document.getElementById('ewalletInstructionText').textContent = `Bayar menggunakan ${ewallet.name} sejumlah ${formatCurrency(currentOrder.prices.total)}`;
            
            document.getElementById('ewalletDetails').style.display = 'block';
            
            // Show instruction
            showEwalletInstruction(ewallet);
        }

        function startCountdownTimer() {
            if (countdownTimer) clearInterval(countdownTimer);
            
            countdownEndTime = Date.now() + 24 * 60 * 60 * 1000; // 24 hours from now
            
            countdownTimer = setInterval(() => {
                const now = Date.now();
                const remaining = countdownEndTime - now;
                
                if (remaining <= 0) {
                    clearInterval(countdownTimer);
                    document.getElementById('countdown').textContent = '00:00:00';
                    onPaymentFailed({ message: 'Virtual Account telah kadaluarsa' });
                    return;
                }
                
                const hours = Math.floor(remaining / (1000 * 60 * 60));
                const minutes = Math.floor((remaining % (1000 * 60 * 60)) / (1000 * 60));
                const seconds = Math.floor((remaining % (1000 * 60)) / 1000);
                
                document.getElementById('countdown').textContent = 
                    `${hours.toString().padStart(2, '0')}:${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
            }, 1000);
        }

        function showQRISInstruction() {
            const instructionDiv = document.getElementById('paymentInstruction');
            const contentDiv = document.getElementById('instructionContent');
            
            contentDiv.innerHTML = `
                <ol style="text-align: left; margin: 10px 0 0 20px;">
                    <li>Buka aplikasi mobile banking/e-wallet Anda</li>
                    <li>Pilih fitur Scan QRIS atau Bayar dengan QR</li>
                    <li>Arahkan kamera ke QR Code di atas</li>
                    <li>Konfirmasi pembayaran sejumlah <strong>${formatCurrency(currentOrder.prices.total)}</strong></li>
                    <li>Tunggu konfirmasi otomatis (1-3 menit)</li>
                    <li>Klik "Cek Status Pembayaran" untuk update status</li>
                </ol>
                <div class="alert alert-info" style="margin-top: 10px;">
                    <i class="fas fa-info-circle"></i> 
                    <strong>Mode Simulasi:</strong> Untuk simulasi pembayaran berhasil, klik tombol "Simulasikan Pembayaran Berhasil"
                </div>
            `;
            
            instructionDiv.style.display = 'block';
        }

        function showVAInstruction(bank, vaNumber) {
            const instructionDiv = document.getElementById('paymentInstruction');
            const contentDiv = document.getElementById('instructionContent');
            
            const expiry = new Date(countdownEndTime).toLocaleString('id-ID');
            
            contentDiv.innerHTML = `
                <ol style="text-align: left; margin: 10px 0 0 20px;">
                    <li>Transfer ke Virtual Account: <strong>${vaNumber}</strong></li>
                    <li>Bank: <strong>${bank.name}</strong></li>
                    <li>Jumlah: <strong>${formatCurrency(currentOrder.prices.total)}</strong></li>
                    <li>Batas waktu: <strong>${expiry}</strong></li>
                    <li>Transfer dari bank yang sama (jika BCA transfer dari BCA)</li>
                    <li>Setelah transfer, klik "Cek Status Pembayaran"</li>
                </ol>
                <div class="alert alert-info" style="margin-top: 10px;">
                    <i class="fas fa-info-circle"></i> 
                    <strong>Mode Simulasi:</strong> VA ini adalah contoh. Untuk simulasi, klik "Simulasikan Pembayaran Berhasil"
                </div>
            `;
            
            instructionDiv.style.display = 'block';
        }

        function showEwalletInstruction(ewallet) {
            const instructionDiv = document.getElementById('paymentInstruction');
            const contentDiv = document.getElementById('instructionContent');
            
            contentDiv.innerHTML = `
                <ol style="text-align: left; margin: 10px 0 0 20px;">
                    <li>Buka aplikasi ${ewallet.name}</li>
                    <li>Pilih menu "Bayar" atau "Scan"</li>
                    <li>Masukkan kode: <strong>WR${currentOrder.id.slice(-6)}</strong></li>
                    <li>Konfirmasi pembayaran sejumlah <strong>${formatCurrency(currentOrder.prices.total)}</strong></li>
                    <li>Tunggu konfirmasi otomatis</li>
                </ol>
                <div class="alert alert-info" style="margin-top: 10px;">
                    <i class="fas fa-info-circle"></i> 
                    <strong>Mode Simulasi:</strong> Kode pembayaran ini adalah contoh. Untuk simulasi, klik "Simulasikan Pembayaran Berhasil"
                </div>
            `;
            
            instructionDiv.style.display = 'block';
        }

        // ================= PAYMENT METHOD SELECTION =================
        function switchPaymentTab(tab) {
            // Update tabs
            document.querySelectorAll('.payment-tab').forEach(btn => {
                btn.classList.remove('active');
            });
            event.target.classList.add('active');
            
            // Hide all tab contents
            document.querySelectorAll('.payment-tab-content').forEach(content => {
                content.style.display = 'none';
            });
            
            // Show selected tab
            document.getElementById(`paymentTab${tab.charAt(0).toUpperCase() + tab.slice(1)}`).style.display = 'block';
            
            // Reset selection
            selectedPaymentMethod = tab;
            selectedBank = null;
            selectedEwallet = null;
            
            // Clear instruction and details
            document.getElementById('paymentInstruction').style.display = 'none';
            document.getElementById('vaDetails').style.display = 'none';
            document.getElementById('ewalletDetails').style.display = 'none';
            
            // Load content based on tab
            if (tab === 'qris') {
                generateSimulationQRCode();
            } else if (tab === 'va') {
                loadBankOptions();
            } else if (tab === 'ewallet') {
                loadEwalletOptions();
            } else if (tab === 'manual') {
                showManualPayment();
            }
        }

        function loadBankOptions() {
            const container = document.getElementById('vaBanks');
            container.innerHTML = BANK_LIST.map(bank => `
                <div class="bank-option" onclick="selectBank('${bank.code}')">
                    <img src="${bank.logo}" alt="${bank.name}" class="bank-logo">
                    <p>${bank.name}</p>
                </div>
            `).join('');
        }

        function loadEwalletOptions() {
            const container = document.getElementById('ewalletOptions');
            container.innerHTML = EWALLET_LIST.map(ewallet => `
                <div class="payment-method-option" onclick="selectEwallet('${ewallet.code}')">
                    <img src="${ewallet.logo}" alt="${ewallet.name}" class="payment-method-logo">
                    <div class="payment-method-info">
                        <div class="payment-method-name">${ewallet.name}</div>
                        <div class="payment-method-fee">Biaya admin sudah termasuk</div>
                    </div>
                </div>
            `).join('');
        }

        function selectBank(bankCode) {
            selectedBank = bankCode;
            
            // Update UI
            document.querySelectorAll('.bank-option').forEach(option => {
                option.classList.remove('selected');
            });
            event.target.closest('.bank-option').classList.add('selected');
            
            // Show VA details
            document.getElementById('vaDetails').style.display = 'block';
            
            // Generate simulation VA
            generateSimulationVA(bankCode);
        }

        function selectEwallet(ewalletCode) {
            selectedEwallet = ewalletCode;
            
            // Update UI
            document.querySelectorAll('.payment-method-option').forEach(option => {
                option.classList.remove('selected');
            });
            event.target.closest('.payment-method-option').classList.add('selected');
            
            // Generate simulation e-wallet
            generateSimulationEwallet(ewalletCode);
        }

        function showManualPayment() {
            document.getElementById('manualAmount').textContent = formatCurrency(currentOrder.prices.total);
            document.getElementById('manualOrderId').textContent = currentOrder.id;
        }

        // ================= PAYMENT PROCESSING =================
        function simulatePayment() {
            // Stop countdown timer if exists
            if (countdownTimer) {
                clearInterval(countdownTimer);
                countdownTimer = null;
            }
            
            // Update order status
            currentOrder.status = 'paid';
            currentOrder.paidAt = new Date().toISOString();
            currentOrder.paymentMethod = selectedPaymentMethod || 'manual';
            updateOrderInStorage(currentOrder);
            
            // Show success message
            const statusDiv = document.getElementById('paymentStatus');
            statusDiv.style.display = 'block';
            statusDiv.className = 'status-success';
            statusDiv.innerHTML = `
                <i class="fas fa-check-circle"></i> 
                <strong>Pembayaran Berhasil Disimulasikan!</strong><br>
                Order ID: ${currentOrder.id}<br>
                Anda akan diarahkan ke WhatsApp dalam 5 detik...
            `;
            
            // Update button
            document.getElementById('simulateBtn').disabled = true;
            document.getElementById('simulateBtn').innerHTML = '<i class="fas fa-check"></i> Pembayaran Simulasi Berhasil';
            
            // Redirect to WhatsApp after 5 seconds
            setTimeout(() => {
                redirectToWhatsApp();
            }, 5000);
        }

        function confirmManualPayment() {
            const message = `Halo Admin WarungRIM,

Saya sudah melakukan pembayaran MANUAL dengan detail:

Order ID: ${currentOrder.id}
Produk: ${currentOrder.productName}
Total: ${formatCurrency(currentOrder.prices.total)}
Metode: Transfer Manual
Bank: ${CONFIG.MANUAL_BANK_NAME}
No. Rek: ${CONFIG.MANUAL_BANK_ACCOUNT}
Nama: ${currentOrder.customer.name}
Email: ${currentOrder.customer.email}
No. HP: ${currentOrder.customer.phone}

Mohon untuk segera diproses. Terima kasih.`;

            const whatsappUrl = `https://wa.me/${CONFIG.WHATSAPP_ADMIN}?text=${encodeURIComponent(message)}`;
            window.open(whatsappUrl, '_blank');
            
            // Update order status
            currentOrder.status = 'pending_manual';
            currentOrder.paymentMethod = 'manual';
            updateOrderInStorage(currentOrder);
            
            // Close modal
            closeCheckoutModal();
            
            alert('Terima kasih! Admin akan memverifikasi pembayaran manual Anda.');
        }

        function checkPaymentStatus() {
            if (!currentOrder) return;
            
            const statusDiv = document.getElementById('paymentStatus');
            statusDiv.style.display = 'block';
            
            if (currentOrder.status === 'paid') {
                statusDiv.className = 'status-success';
                statusDiv.innerHTML = `
                    <i class="fas fa-check-circle"></i> 
                    <strong>Pembayaran Sudah Berhasil</strong><br>
                    Order ID: ${currentOrder.id}
                `;
            } else {
                statusDiv.className = 'status-warning';
                statusDiv.innerHTML = `
                    <i class="fas fa-clock"></i> 
                    <strong>Menunggu Pembayaran</strong><br>
                    Status: Pending
                    ${CONFIG.PAYMENT_MODE === 'simulation' ? '<br><small>Mode Simulasi: Klik "Simulasikan Pembayaran Berhasil"</small>' : ''}
                `;
            }
        }

        function onPaymentFailed(status) {
            // Update order status
            currentOrder.status = 'failed';
            updateOrderInStorage(currentOrder);
            
            // Show error message
            const statusDiv = document.getElementById('paymentStatus');
            statusDiv.style.display = 'block';
            statusDiv.className = 'status-error';
            statusDiv.innerHTML = `
                <i class="fas fa-times-circle"></i> 
                <strong>Pembayaran Gagal</strong><br>
                ${status.message || 'Pembayaran telah kadaluarsa atau gagal.'}<br>
                Silakan coba lagi dengan metode pembayaran lain.
            `;
            
            // Return stock if jasa product
            if (currentOrder.productType === 'jasa') {
                addStock(currentOrder.productId, 'jasa', 1);
            }
        }

        // ================= STOCK MANAGEMENT =================
        function checkStock(productId, category) {
            const product = products[category].find(p => p.id === productId);
            if (!product) return { available: false, message: "Produk tidak ditemukan" };
            
            if (product.type === 'ewallet') {
                return { available: true, stock: product.stock };
            }
            
            if (product.stock <= 0) {
                return { 
                    available: false, 
                    stock: 0,
                    message: "Maaf, stok produk habis. Silakan hubungi admin untuk restock."
                };
            }
            
            return { available: true, stock: product.stock };
        }

        function updateStock(productId, category, quantity = 1) {
            const product = products[category].find(p => p.id === productId);
            if (product && product.type === 'jasa') {
                product.stock -= quantity;
                if (product.stock < 0) product.stock = 0;
                saveProductsToStorage();
                renderProducts();
                return true;
            }
            return false;
        }

        function addStock(productId, category, quantity) {
            const product = products[category].find(p => p.id === productId);
            if (product) {
                product.stock += parseInt(quantity);
                saveProductsToStorage();
                renderProducts();
                return true;
            }
            return false;
        }

        // ================= PRODUCT DISPLAY =================
        function renderProducts() {
            // Render top products
            const topProductsContainer = document.getElementById('topProducts');
            const topProducts = products.jasa.filter(p => p.isActive).slice(0, 3);
            
            topProductsContainer.innerHTML = topProducts.map(product => {
                const stockStatus = checkStock(product.id, 'jasa');
                const isDisabled = !stockStatus.available;
                
                return `
                <div class="product-card ${isDisabled ? 'disabled' : ''}" 
                     onclick="${isDisabled ? 'showStockAlert()' : `showCheckoutModal(${product.id}, 'jasa')`}">
                    ${product.stock > 0 ? 
                      `<span class="stock-badge">Stock: ${product.stock}</span>` : 
                      `<span class="stock-badge stock-out">Habis</span>`}
                    <div class="product-icon" style="background: linear-gradient(135deg, ${product.color}20, ${product.color}40); color: ${product.color};">
                        <i class="${product.image}"></i>
                    </div>
                    <h3>${product.name}</h3>
                    <div class="product-price">${formatCurrency(product.basePrice)}</div>
                    <div class="product-note">${isDisabled ? 'Stok habis' : 'Sudah termasuk semua biaya'}</div>
                </div>`;
            }).join('');

            // Render category products
            const productsContainer = document.getElementById('productsGrid');
            const categoryProducts = products[currentCategory].filter(p => p.isActive);
            
            productsContainer.innerHTML = categoryProducts.map(product => {
                const stockStatus = checkStock(product.id, currentCategory);
                const isDisabled = !stockStatus.available && product.type === 'jasa';
                
                if (currentCategory === 'jasa') {
                    return `
                    <div class="product-card ${isDisabled ? 'disabled' : ''}" 
                         onclick="${isDisabled ? 'showStockAlert()' : `showCheckoutModal(${product.id}, 'jasa')`}">
                        ${product.stock > 0 ? 
                          `<span class="stock-badge">Stock: ${product.stock}</span>` : 
                          `<span class="stock-badge stock-out">Habis</span>`}
                        <div class="product-icon" style="background: linear-gradient(135deg, ${product.color}20, ${product.color}40); color: ${product.color};">
                            <i class="${product.image}"></i>
                        </div>
                        <h3>${product.name}</h3>
                        <div class="product-price">${formatCurrency(product.basePrice)}</div>
                        <div class="product-note">${isDisabled ? 'Stok habis' : product.description}</div>
                    </div>`;
                } else {
                    return `
                    <div class="product-card" onclick="showCheckoutModal(${product.id}, 'ewallet')">
                        <span class="stock-badge">Tersedia</span>
                        <div class="product-icon" style="background: linear-gradient(135deg, ${product.color}20, ${product.color}40); color: ${product.color};">
                            <i class="${product.image}"></i>
                        </div>
                        <h3>${product.name}</h3>
                        <div class="product-price">Pilih Nominal</div>
                        <div class="product-note">${product.description}</div>
                    </div>`;
                }
            }).join('');
        }

        function showStockAlert() {
            alert('Maaf, stok produk ini habis. Silakan hubungi admin untuk informasi restock.');
        }

        function switchCategory(category) {
            currentCategory = category;
            
            // Update tabs
            document.querySelectorAll('.tab-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            event.target.classList.add('active');
            
            // Update title
            document.getElementById('categoryTitle').textContent = 
                category === 'jasa' ? 'JASA DIGITAL' : 'TOP UP E-WALLET';
            
            // Render products
            renderProducts();
        }

        // ================= CHECKOUT MODAL =================
        function showCheckoutModal(productId, category) {
            currentProduct = products[category].find(p => p.id === productId);
            
            if (!currentProduct) {
                alert('Produk tidak ditemukan!');
                return;
            }
            
            // Cek stock untuk produk jasa
            if (category === 'jasa') {
                const stockStatus = checkStock(productId, category);
                if (!stockStatus.available) {
                    alert(stockStatus.message);
                    return;
                }
            }
            
            selectedNominal = null;
            selectedPaymentMethod = null;
            selectedBank = null;
            selectedEwallet = null;
            paymentTransaction = null;
            
            // Reset form
            document.getElementById('customerName').value = '';
            document.getElementById('customerEmail').value = '';
            document.getElementById('customerPhone').value = '';
            
            // Reset payment tabs
            document.querySelectorAll('.payment-tab').forEach((tab, index) => {
                tab.classList.remove('active');
                if (index === 0) tab.classList.add('active');
            });
            
            document.querySelectorAll('.payment-tab-content').forEach((content, index) => {
                content.style.display = index === 0 ? 'block' : 'none';
            });
            
            // Clear previous status
            document.getElementById('paymentStatus').style.display = 'none';
            document.getElementById('paymentInstruction').style.display = 'none';
            document.getElementById('vaDetails').style.display = 'none';
            document.getElementById('ewalletDetails').style.display = 'none';
            
            // Show product details
            const productDetails = document.getElementById('productDetails');
            const stockStatusDiv = document.getElementById('stockStatus');
            
            if (category === 'jasa') {
                productDetails.innerHTML = `
                    <h4 style="text-align: center; margin-bottom: 15px;">${currentProduct.name}</h4>
                    <p style="text-align: center; color: #666; margin-bottom: 15px;">${currentProduct.description}</p>
                `;
                
                // Tampilkan status stock
                stockStatusDiv.style.display = 'block';
                stockStatusDiv.className = currentProduct.stock > 0 ? 'alert alert-success' : 'alert alert-danger';
                stockStatusDiv.innerHTML = `
                    <i class="fas fa-box"></i> 
                    Stok tersedia: <strong>${currentProduct.stock}</strong> unit
                    ${currentProduct.stock <= 3 ? '<br><small>Stok terbatas, segera pesan!</small>' : ''}
                `;
                
                // Sembunyikan bagian nominal
                document.getElementById('ewalletNominals').style.display = 'none';
                
                // Update harga
                const basePrice = currentProduct.basePrice;
                const adminFee = Math.ceil(basePrice * (CONFIG.FEE_PERCENTAGE / 100));
                const totalPrice = basePrice + adminFee;
                
                document.getElementById('priceBase').textContent = formatCurrency(basePrice);
                document.getElementById('priceFee').textContent = 'Rp 0';
                document.getElementById('priceAdmin').textContent = formatCurrency(adminFee);
                document.getElementById('priceTotal').textContent = formatCurrency(totalPrice);
                
            } else {
                productDetails.innerHTML = `
                    <h4 style="text-align: center; margin-bottom: 15px;">Top Up ${currentProduct.name}</h4>
                    <p style="text-align: center; color: #666; margin-bottom: 15px;">${currentProduct.description}</p>
                `;
                
                // Sembunyikan status stock untuk e-wallet
                stockStatusDiv.style.display = 'none';
                
                // Tampilkan pilihan nominal
                const ewalletNominals = document.getElementById('ewalletNominals');
                ewalletNominals.style.display = 'block';
                ewalletNominals.innerHTML = `
                    <h5 style="margin-bottom: 15px;">Pilih Nominal:</h5>
                    <div class="nominal-grid" id="nominalOptions"></div>
                `;
                
                // Generate nominal options
                const nominalOptions = document.getElementById('nominalOptions');
                nominalOptions.innerHTML = EWALLET_NOMINALS.map(nominal => {
                    const fee = calculateEwalletFee(nominal);
                    return `
                    <div class="nominal-option" onclick="selectEwalletNominal(${nominal})">
                        <div class="nominal-amount">${formatCurrency(nominal)}</div>
                        <div class="nominal-fee">+ ${formatCurrency(fee)}</div>
                    </div>`;
                }).join('');
                
                // Reset harga
                document.getElementById('priceBase').textContent = '-';
                document.getElementById('priceFee').textContent = '-';
                document.getElementById('priceAdmin').textContent = '-';
                document.getElementById('priceTotal').textContent = '-';
            }
            
            // Enable/disable tombol proceed
            const btnProceed = document.getElementById('btnProceedPayment');
            if (category === 'jasa') {
                btnProceed.disabled = false;
                btnProceed.innerHTML = '<i class="fas fa-credit-card"></i> Lanjutkan ke Pembayaran';
            } else {
                btnProceed.disabled = true;
                btnProceed.innerHTML = '<i class="fas fa-credit-card"></i> Pilih nominal terlebih dahulu';
            }
            
            // Tampilkan modal
            document.getElementById('checkoutModal').style.display = 'flex';
            document.getElementById('step1').style.display = 'block';
            document.getElementById('step2').style.display = 'none';
        }

        function selectEwalletNominal(nominal) {
            selectedNominal = nominal;
            
            // Update selected style
            document.querySelectorAll('.nominal-option').forEach(option => {
                option.classList.remove('selected');
            });
            event.target.classList.add('selected');
            
            // Calculate prices
            const basePrice = nominal;
            const serviceFee = calculateEwalletFee(nominal);
            const adminFee = Math.ceil((basePrice + serviceFee) * (CONFIG.FEE_PERCENTAGE / 100));
            const totalPrice = basePrice + serviceFee + adminFee;
            
            // Update display
            document.getElementById('priceBase').textContent = formatCurrency(basePrice);
            document.getElementById('priceFee').textContent = formatCurrency(serviceFee);
            document.getElementById('priceAdmin').textContent = formatCurrency(adminFee);
            document.getElementById('priceTotal').textContent = formatCurrency(totalPrice);
            
            // Enable proceed button
            const btnProceed = document.getElementById('btnProceedPayment');
            btnProceed.disabled = false;
            btnProceed.innerHTML = '<i class="fas fa-credit-card"></i> Lanjutkan ke Pembayaran';
        }

        function proceedToPayment() {
            // Validasi form
            const customerName = document.getElementById('customerName').value.trim();
            const customerEmail = document.getElementById('customerEmail').value.trim();
            const customerPhone = document.getElementById('customerPhone').value.trim();
            
            if (!customerName || !customerEmail || !customerPhone) {
                alert('Harap isi semua data dengan benar!');
                return;
            }
            
            if (currentProduct.type === 'ewallet' && !selectedNominal) {
                alert('Harap pilih nominal terlebih dahulu!');
                return;
            }
            
            // Cek stock lagi sebelum proses
            if (currentProduct.type === 'jasa') {
                const stockStatus = checkStock(currentProduct.id, 'jasa');
                if (!stockStatus.available) {
                    alert(stockStatus.message);
                    renderProducts(); // Refresh tampilan produk
                    return;
                }
            }
            
            // Generate order
            generateOrder();
        }

        function generateOrder() {
            const orderId = 'WR' + Date.now() + Math.floor(Math.random() * 1000);
            const customerName = document.getElementById('customerName').value;
            const customerEmail = document.getElementById('customerEmail').value;
            const customerPhone = document.getElementById('customerPhone').value;
            
            // Calculate final price
            let basePrice, serviceFee, adminFee, totalPrice, productName;
            
            if (currentProduct.type === 'jasa') {
                basePrice = currentProduct.basePrice;
                serviceFee = 0;
                adminFee = Math.ceil(basePrice * (CONFIG.FEE_PERCENTAGE / 100));
                totalPrice = basePrice + adminFee;
                productName = currentProduct.name;
            } else {
                basePrice = selectedNominal;
                serviceFee = calculateEwalletFee(selectedNominal);
                adminFee = Math.ceil((basePrice + serviceFee) * (CONFIG.FEE_PERCENTAGE / 100));
                totalPrice = basePrice + serviceFee + adminFee;
                productName = `${currentProduct.name} ${formatCurrency(selectedNominal)}`;
            }
            
            // Create order object
            currentOrder = {
                id: orderId,
                productId: currentProduct.id,
                productName: productName,
                productType: currentProduct.type,
                customer: {
                    name: customerName,
                    email: customerEmail,
                    phone: customerPhone
                },
                prices: {
                    base: basePrice,
                    service: serviceFee,
                    admin: adminFee,
                    total: totalPrice
                },
                status: 'pending',
                createdAt: new Date().toISOString(),
                paidAt: null,
                paymentMethod: null,
                transactionId: null
            };
            
            // Kurangi stock jika produk jasa
            if (currentProduct.type === 'jasa') {
                updateStock(currentProduct.id, 'jasa', 1);
            }
            
            // Simpan ke localStorage
            saveOrderToStorage(currentOrder);
            
            // Tampilkan step 2
            showPaymentStep();
        }

        function showPaymentStep() {
            document.getElementById('step1').style.display = 'none';
            document.getElementById('step2').style.display = 'block';
            
            // Reset payment selection
            selectedPaymentMethod = 'qris';
            selectedBank = null;
            selectedEwallet = null;
            
            // Enable simulation button
            document.getElementById('simulateBtn').disabled = false;
            document.getElementById('simulateBtn').innerHTML = '<i class="fas fa-flask"></i> Simulasikan Pembayaran Berhasil';
            
            // Generate default QRIS
            generateSimulationQRCode();
        }

        function redirectToWhatsApp() {
            const message = `Halo Admin WarungRIM,

Saya sudah melakukan pembayaran dengan detail:

Order ID: ${currentOrder.id}
Produk: ${currentOrder.productName}
Total: ${formatCurrency(currentOrder.prices.total)}
Metode: ${selectedPaymentMethod ? selectedPaymentMethod.toUpperCase() : '-'} ${CONFIG.PAYMENT_MODE === 'simulation' ? '(Simulasi)' : ''}
Nama: ${currentOrder.customer.name}
Email: ${currentOrder.customer.email}
No. HP: ${currentOrder.customer.phone}

Mohon untuk segera diproses. Terima kasih.`;

            const whatsappUrl = `https://wa.me/${CONFIG.WHATSAPP_ADMIN}?text=${encodeURIComponent(message)}`;
            window.open(whatsappUrl, '_blank');
            
            // Close modal
            closeCheckoutModal();
        }

        function backToStep1() {
            // Kembalikan stock jika dibatalkan
            if (currentOrder && currentOrder.productType === 'jasa' && currentOrder.status !== 'paid') {
                addStock(currentOrder.productId, 'jasa', 1);
            }
            
            // Stop countdown timer
            if (countdownTimer) {
                clearInterval(countdownTimer);
                countdownTimer = null;
            }
            
            document.getElementById('step1').style.display = 'block';
            document.getElementById('step2').style.display = 'none';
        }

        function closeCheckoutModal() {
            // Stop countdown timer
            if (countdownTimer) {
                clearInterval(countdownTimer);
                countdownTimer = null;
            }
            
            document.getElementById('checkoutModal').style.display = 'none';
            currentProduct = null;
            selectedNominal = null;
            currentOrder = null;
            selectedPaymentMethod = null;
            selectedBank = null;
            selectedEwallet = null;
            paymentTransaction = null;
        }

        // ================= ADMIN FUNCTIONS =================
        function showAdminPanel() {
            document.getElementById('adminModal').style.display = 'flex';
        }

        function closeAdminModal() {
            document.getElementById('adminModal').style.display = 'none';
        }

        function loginAdmin() {
            const username = document.getElementById('adminUsername').value;
            const password = document.getElementById('adminPassword').value;
            
            if (username === CONFIG.ADMIN_USERNAME && password === CONFIG.ADMIN_PASSWORD) {
                document.getElementById('adminLogin').style.display = 'none';
                document.getElementById('adminDashboard').style.display = 'block';
                loadAdminData();
            } else {
                alert('Username atau password salah!');
            }
        }

        function logoutAdmin() {
            document.getElementById('adminLogin').style.display = 'block';
            document.getElementById('adminDashboard').style.display = 'none';
            document.getElementById('adminUsername').value = '';
            document.getElementById('adminPassword').value = '';
        }

        function showAdminTab(tabName) {
            adminTab = tabName;
            
            // Update tabs
            document.querySelectorAll('.admin-tab').forEach(tab => {
                tab.style.display = 'none';
            });
            document.getElementById(`admin${tabName.charAt(0).toUpperCase() + tabName.slice(1)}Tab`).style.display = 'block';
            
            // Update tab buttons
            document.querySelectorAll('.tab-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            event.target.classList.add('active');
            
            // Load data berdasarkan tab
            if (tabName === 'products') {
                loadAdminProducts();
            } else if (tabName === 'transactions') {
                loadAdminTransactions();
            } else if (tabName === 'stock') {
                loadStockManagement();
            } else if (tabName === 'settings') {
                loadAdminSettings();
            }
        }

        function loadAdminData() {
            loadAdminProducts();
            loadAdminTransactions();
            loadStockManagement();
            loadAdminSettings();
            
            // Update payment mode display
            document.getElementById('paymentModeStatus').textContent = 
                CONFIG.PAYMENT_MODE === 'simulation' ? 'Simulasi' : 'Production';
        }

        function loadAdminProducts() {
            const container = document.getElementById('adminProductsList');
            
            let html = '<div style="display: grid; gap: 15px;">';
            
            // Tampilkan produk jasa
            html += '<h6>Jasa Digital:</h6>';
            products.jasa.forEach(product => {
                html += `
                <div style="background: white; padding: 15px; border-radius: 8px; border: 1px solid #eee;">
                    <div style="display: flex; justify-content: space-between; align-items: center;">
                        <div>
                            <strong>${product.name}</strong><br>
                            <small>${formatCurrency(product.basePrice)} â¢ Stock: ${product.stock}</small>
                        </div>
                        <div>
                            <button onclick="editProduct(${product.id}, 'jasa')" style="background: #007bff; color: white; border: none; padding: 5px 10px; border-radius: 4px; margin-right: 5px; cursor: pointer;">
                                <i class="fas fa-edit"></i>
                            </button>
                            <button onclick="toggleProductStatus(${product.id}, 'jasa')" style="background: ${product.isActive ? '#6c757d' : '#28a745'}; color: white; border: none; padding: 5px 10px; border-radius: 4px; cursor: pointer;">
                                <i class="fas fa-${product.isActive ? 'eye-slash' : 'eye'}"></i>
                            </button>
                        </div>
                    </div>
                </div>`;
            });
            
            // Tampilkan produk e-wallet
            html += '<h6 style="margin-top: 20px;">E-wallet:</h6>';
            products.ewallet.forEach(product => {
                html += `
                <div style="background: white; padding: 15px; border-radius: 8px; border: 1px solid #eee;">
                    <div style="display: flex; justify-content: space-between; align-items: center;">
                        <div>
                            <strong>${product.name}</strong><br>
                            <small>${product.description}</small>
                        </div>
                        <div>
                            <button onclick="editProduct(${product.id}, 'ewallet')" style="background: #007bff; color: white; border: none; padding: 5px 10px; border-radius: 4px; margin-right: 5px; cursor: pointer;">
                                <i class="fas fa-edit"></i>
                            </button>
                            <button onclick="toggleProductStatus(${product.id}, 'ewallet')" style="background: ${product.isActive ? '#6c757d' : '#28a745'}; color: white; border: none; padding: 5px 10px; border-radius: 4px; cursor: pointer;">
                                <i class="fas fa-${product.isActive ? 'eye-slash' : 'eye'}"></i>
                            </button>
                        </div>
                    </div>
                </div>`;
            });
            
            html += '</div>';
            container.innerHTML = html;
        }

        function loadAdminTransactions() {
            const orders = getOrdersFromStorage();
            const container = document.getElementById('transactionsList');
            
            // Update stats
            document.getElementById('totalTransactions').textContent = orders.length;
            
            const totalIncome = orders.reduce((sum, order) => sum + order.prices.total, 0);
            document.getElementById('totalIncome').textContent = formatCurrency(totalIncome);
            
            const today = new Date().toDateString();
            const todayOrders = orders.filter(order => 
                new Date(order.createdAt).toDateString() === today
            );
            document.getElementById('todayTransactions').textContent = todayOrders.length;
            
            // Display transactions
            if (orders.length === 0) {
                container.innerHTML = '<p style="text-align: center; color: #666; padding: 20px;">Belum ada transaksi</p>';
                return;
            }
            
            let html = '<div style="display: grid; gap: 10px;">';
            orders.slice(-10).reverse().forEach(order => {
                let statusText, statusColor;
                switch(order.status) {
                    case 'paid':
                        statusText = 'â Lunas';
                        statusColor = '#28a745';
                        break;
                    case 'failed':
                        statusText = 'â Gagal';
                        statusColor = '#dc3545';
                        break;
                    case 'pending_manual':
                        statusText = 'â³ Manual';
                        statusColor = '#ffc107';
                        break;
                    default:
                        statusText = 'â³ Pending';
                        statusColor = '#ffc107';
                }
                
                html += `
                <div style="background: white; padding: 12px; border-radius: 6px; border: 1px solid #eee;">
                    <div style="display: flex; justify-content: space-between;">
                        <div>
                            <strong>${order.id}</strong><br>
                            <small>${order.productName}</small>
                        </div>
                        <div style="text-align: right;">
                            <span style="color: ${statusColor}; font-weight: bold;">
                                ${statusText}
                            </span><br>
                            <small>${formatCurrency(order.prices.total)}</small>
                        </div>
                    </div>
                    <div style="margin-top: 8px; font-size: 12px; color: #666;">
                        <i class="fas fa-user"></i> ${order.customer.name} â¢ 
                        <i class="fas fa-credit-card"></i> ${order.paymentMethod || '-'} â¢ 
                        <i class="fas fa-clock"></i> ${new Date(order.createdAt).toLocaleString('id-ID')}
                    </div>
                </div>`;
            });
            html += '</div>';
            container.innerHTML = html;
        }

        function loadStockManagement() {
            const container = document.getElementById('stockManagement');
            
            let html = '<div style="display: grid; gap: 15px;">';
            
            products.jasa.forEach(product => {
                html += `
                <div style="background: white; padding: 15px; border-radius: 8px; border: 1px solid #eee;">
                    <div style="display: flex; justify-content: space-between; align-items: center;">
                        <div>
                            <strong>${product.name}</strong><br>
                            <small>Stock saat ini: <span style="font-weight: bold; color: ${product.stock > 0 ? '#28a745' : '#dc3545'}">${product.stock}</span></small>
                        </div>
                        <div style="display: flex; gap: 10px; align-items: center;">
                            <input type="number" id="stockInput${product.id}" class="stock-input" min="1" max="1000" value="10" style="width: 80px;">
                            <button onclick="updateProductStock(${product.id}, 'jasa')" style="background: #28a745; color: white; border: none; padding: 8px 12px; border-radius: 4px; cursor: pointer;">
                                <i class="fas fa-plus"></i> Tambah Stock
                            </button>
                        </div>
                    </div>
                </div>`;
            });
            
            html += '</div>';
            container.innerHTML = html;
        }

        function loadAdminSettings() {
            // Load saved config
            const savedConfig = getPaymentConfig();
            if (savedConfig) {
                document.getElementById('configApiKey').value = savedConfig.apiKey || '';
                document.getElementById('configSecretKey').value = savedConfig.secretKey || '';
                document.getElementById('paymentMode').value = savedConfig.mode || 'simulation';
                document.getElementById('adminWhatsapp').value = savedConfig.whatsapp || CONFIG.WHATSAPP_ADMIN;
            }
        }

        function updatePaymentConfig() {
            const apiKey = document.getElementById('configApiKey').value;
            const secretKey = document.getElementById('configSecretKey').value;
            const mode = document.getElementById('paymentMode').value;
            
            const config = {
                apiKey: apiKey,
                secretKey: secretKey,
                mode: mode,
                updatedAt: new Date().toISOString()
            };
            
            localStorage.setItem('warungrim_payment_config', JSON.stringify(config));
            
            // Update CONFIG
            CONFIG.VMPAY_API_KEY = apiKey;
            CONFIG.VMPAY_SECRET_KEY = secretKey;
            CONFIG.PAYMENT_MODE = mode;
            
            // Update UI
            document.getElementById('paymentModeStatus').textContent = 
                mode === 'simulation' ? 'Simulasi' : 'Production';
            
            // Update test mode badge
            const badge = document.getElementById('testModeBadge');
            if (mode === 'simulation') {
                badge.style.display = 'block';
                badge.innerHTML = '<i class="fas fa-flask"></i> MODE SIMULASI';
            } else {
                badge.style.display = 'none';
            }
            
            alert('Konfigurasi pembayaran berhasil diperbarui!');
        }

        function updateAdminContact() {
            const whatsapp = document.getElementById('adminWhatsapp').value;
            CONFIG.WHATSAPP_ADMIN = whatsapp;
            localStorage.setItem('warungrim_admin_contact', whatsapp);
            alert('Nomor WhatsApp admin berhasil diperbarui!');
        }

        function saveVMPayConfig() {
            const apiKey = document.getElementById('vmpayApiKey').value;
            const secretKey = document.getElementById('vmpaySecretKey').value;
            
            if (!apiKey || !secretKey) {
                alert('Harap isi API Key dan Secret Key!');
                return;
            }
            
            const config = {
                apiKey: apiKey,
                secretKey: secretKey,
                mode: 'production',
                updatedAt: new Date().toISOString()
            };
            
            localStorage.setItem('warungrim_payment_config', JSON.stringify(config));
            
            // Update CONFIG
            CONFIG.VMPAY_API_KEY = apiKey;
            CONFIG.VMPAY_SECRET_KEY = secretKey;
            CONFIG.PAYMENT_MODE = 'production';
            
            // Hide test mode badge
            document.getElementById('testModeBadge').style.display = 'none';
            
            alert('Konfigurasi Violet Media Pay berhasil disimpan! Sistem sekarang dalam mode production.');
            
            // Close admin panel
            closeAdminModal();
        }

        function getPaymentConfig() {
            const saved = localStorage.getItem('warungrim_payment_config');
            return saved ? JSON.parse(saved) : null;
        }

        function updateProductStock(productId, category) {
            const input = document.getElementById(`stockInput${productId}`);
            const quantity = parseInt(input.value);
            
            if (isNaN(quantity) || quantity <= 0) {
                alert('Masukkan jumlah stock yang valid!');
                return;
            }
            
            if (addStock(productId, category, quantity)) {
                alert(`Stock berhasil ditambahkan sebanyak ${quantity} unit!`);
                loadStockManagement();
                loadAdminProducts();
                renderProducts(); // Update tampilan user
            } else {
                alert('Gagal menambah stock!');
            }
        }

        function toggleProductStatus(productId, category) {
            const product = products[category].find(p => p.id === productId);
            if (product) {
                product.isActive = !product.isActive;
                saveProductsToStorage();
                loadAdminProducts();
                renderProducts();
                alert(`Produk ${product.isActive ? 'diaktifkan' : 'dinonaktifkan'}!`);
            }
        }

        function editProduct(productId, category) {
            const product = products[category].find(p => p.id === productId);
            if (!product) return;
            
            const newPrice = prompt('Masukkan harga baru:', product.basePrice);
            if (newPrice && !isNaN(newPrice)) {
                product.basePrice = parseInt(newPrice);
                saveProductsToStorage();
                loadAdminProducts();
                renderProducts();
                alert('Harga berhasil diupdate!');
            }
        }

        function addNewProduct() {
            const name = prompt('Nama produk baru:');
            if (!name) return;
            
            const price = prompt('Harga produk:');
            if (!price || isNaN(price)) return;
            
            const stock = prompt('Stock awal:', '10');
            if (!stock || isNaN(stock)) return;
            
            const newProduct = {
                id: Date.now(),
                name: name,
                basePrice: parseInt(price),
                image: "fas fa-box",
                color: "#" + Math.floor(Math.random()*16777215).toString(16),
                description: "Produk baru",
                stock: parseInt(stock),
                type: "jasa",
                isActive: true
            };
            
            products.jasa.push(newProduct);
            saveProductsToStorage();
            loadAdminProducts();
            renderProducts();
            alert('Produk baru berhasil ditambahkan!');
        }

        // ================= STORAGE FUNCTIONS =================
        function saveProductsToStorage() {
            localStorage.setItem('warungrim_products', JSON.stringify(products));
        }

        function loadProductsFromStorage() {
            const saved = localStorage.getItem('warungrim_products');
            if (saved) {
                try {
                    products = JSON.parse(saved);
                } catch (e) {
                    console.error('Error loading products:', e);
                }
            }
        }

        function saveOrderToStorage(order) {
            const orders = getOrdersFromStorage();
            orders.push(order);
            localStorage.setItem('warungrim_orders', JSON.stringify(orders));
        }

        function getOrdersFromStorage() {
            const saved = localStorage.getItem('warungrim_orders');
            return saved ? JSON.parse(saved) : [];
        }

        function updateOrderInStorage(updatedOrder) {
            const orders = getOrdersFromStorage();
            const index = orders.findIndex(o => o.id === updatedOrder.id);
            if (index !== -1) {
                orders[index] = updatedOrder;
                localStorage.setItem('warungrim_orders', JSON.stringify(orders));
            }
        }

        // ================= INITIALIZATION =================
        document.addEventListener('DOMContentLoaded', function() {
            // Load data dari localStorage
            loadProductsFromStorage();
            
            // Load payment config
            const savedConfig = getPaymentConfig();
            if (savedConfig) {
                CONFIG.VMPAY_API_KEY = savedConfig.apiKey || '';
                CONFIG.VMPAY_SECRET_KEY = savedConfig.secretKey || '';
                CONFIG.PAYMENT_MODE = savedConfig.mode || 'simulation';
            }
            
            // Update test mode badge
            const badge = document.getElementById('testModeBadge');
            if (CONFIG.PAYMENT_MODE === 'simulation') {
                badge.style.display = 'block';
            } else {
                badge.style.display = 'none';
            }
            
            // Render produk
            renderProducts();
            
            // Setup form submission
            document.getElementById('checkoutModal').addEventListener('click', function(e) {
                if (e.target === this) {
                    closeCheckoutModal();
                }
            });
            
            // Setup admin modal close
            document.getElementById('adminModal').addEventListener('click', function(e) {
                if (e.target === this) {
                    closeAdminModal();
                }
            });
        });
    </script>
</body>
                                                       </html>
